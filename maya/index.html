<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.0"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="This document serves both as an introduction to the integration project of Zcash/ZEC into Maya Protocol (MP) and a technical feasibility study. In the first, we describe the architecture of MP and the workflows for deposit/withdraw and swap.
Next, we’ll discuss how to add ZEC as a new chain which will allow the creation of the liquidity pool ZEC.
We aim to have transparent & shielded ZEC available both as a source and a destination of a swap."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Maya Protocol / Zcash :: YWallet"><meta name=twitter:description content="This document serves both as an introduction to the integration project of Zcash/ZEC into Maya Protocol (MP) and a technical feasibility study. In the first, we describe the architecture of MP and the workflows for deposit/withdraw and swap.
Next, we’ll discuss how to add ZEC as a new chain which will allow the creation of the liquidity pool ZEC.
We aim to have transparent & shielded ZEC available both as a source and a destination of a swap."><meta property="og:url" content="https://ywallet.app/maya/index.html"><meta property="og:site_name" content="YWallet"><meta property="og:title" content="Maya Protocol / Zcash :: YWallet"><meta property="og:description" content="This document serves both as an introduction to the integration project of Zcash/ZEC into Maya Protocol (MP) and a technical feasibility study. In the first, we describe the architecture of MP and the workflows for deposit/withdraw and swap.
Next, we’ll discuss how to add ZEC as a new chain which will allow the creation of the liquidity pool ZEC.
We aim to have transparent & shielded ZEC available both as a source and a destination of a swap."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Maya Protocol / Zcash :: YWallet"><meta itemprop=description content="This document serves both as an introduction to the integration project of Zcash/ZEC into Maya Protocol (MP) and a technical feasibility study. In the first, we describe the architecture of MP and the workflows for deposit/withdraw and swap.
Next, we’ll discuss how to add ZEC as a new chain which will allow the creation of the liquidity pool ZEC.
We aim to have transparent & shielded ZEC available both as a source and a destination of a swap."><meta itemprop=wordCount content="2009"><title>Maya Protocol / Zcash :: YWallet</title>
<link href=/maya/index.xml rel=alternate type=application/rss+xml title="Maya Protocol / Zcash :: YWallet"><link href=/css/fontawesome-all.min.css?1714513868 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1714513868 rel=stylesheet></noscript><link href=/css/nucleus.css?1714513868 rel=stylesheet><link href=/css/auto-complete.css?1714513868 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1714513868 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1714513868 rel=stylesheet><link href=/css/fonts.css?1714513868 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1714513868 rel=stylesheet></noscript><link href=/css/theme.css?1714513868 rel=stylesheet><link href=/css/theme-auto.css?1714513868 rel=stylesheet id=R-variant-style><link href=/css/chroma-auto.css?1714513868 rel=stylesheet id=R-variant-chroma-style><link href=/css/variant.css?1714513868 rel=stylesheet><link href=/css/print.css?1714513868 rel=stylesheet media=print><script src=/js/variant.js?1714513868></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://ywallet.app",window.index_js_url="/index.search.js",window.variants&&variants.init(["auto"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script></head><body class="mobile-support html" data-url=/maya/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#overview-of-maya-protocol>Overview of Maya Protocol</a><ul><li><a href=#dex>DEX</a></li><li><a href=#cex>CEX</a></li><li><a href=#liquidity-pools>Liquidity Pools</a></li><li><a href=#swaps>Swaps</a></li><li><a href=#memos>Memos</a></li></ul></li><li><a href=#components>Components</a><ul><li><a href=#maya-blockchain>Maya blockchain</a></li><li><a href=#asguard-vault>Asguard Vault</a></li><li><a href=#mayanode>MayaNode</a></li><li><a href=#bifrost>Bifrost</a></li></ul></li><li><a href=#adding-zec-1>Adding ZEC</a><ul><li><a href=#bitcoin>Bitcoin</a></li><li><a href=#transparent-zec>Transparent ZEC</a></li><li><a href=#shielded-zec>Shielded ZEC</a></li><li><a href=#tss>TSS</a></li><li><a href=#btcd>BTCD</a></li></ul></li><li><a href=#smoke-tests>Smoke Tests</a></li><li><a href=#docker--deployment>Docker & Deployment</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>YWallet</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Maya Protocol / Zcash</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/audit/index.html title="Security & Audit (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/maya/deposit/index.html title="Deposit (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=maya-protocol--zcash>Maya Protocol / Zcash</h1><p>This document serves both as an introduction to the integration
project of Zcash/ZEC into Maya Protocol (MP) and a technical feasibility
study. In the first, we describe the architecture of MP and the workflows
for deposit/withdraw and swap.</p><p>Next, we&rsquo;ll discuss how to add ZEC as a new chain which will allow
the creation of the liquidity pool ZEC.</p><p>We aim to have transparent & shielded ZEC available both as a
source and a destination of a swap.</p><p>We&rsquo;ll use Bitcoin as a starting point since ZEC data model and
implementation are closely related (
at least for the transparent addresses).</p><p>We&rsquo;ll also discuss how shielded ZEC can be added.</p><p>The code accompanying this document
can be found at
<a href="https://gitlab.com/hanh00/mayanode/-/tree/zcash-dev?ref_type=heads" rel=external target=_blank>zcash-dev</a></p><h2 id=overview-of-maya-protocol>Overview of Maya Protocol</h2><h3 id=dex>DEX</h3><p>MP is a Decentralized Exchange. The main use case is to
exchange one crypto currency for another. There are multiple
cryptos supported, among which we have Bitcoin, Ethereum, etc.</p><p>The goal of the project is to add Zcash, i.e. ZEC, so that
any user can exchange (swap) ZEC for any currency
that MP supports (or vice-versa).</p><p>Traditionally, one would have to use the services of an
exchange like Binance. But these exchanges require KYC
and hold your funds. They are
called centralized exchanges (CEX).</p><h3 id=cex>CEX</h3><p>Users of a CEX place buy or sell orders on the platform.
The platform continuously attempts to match buy and sell
orders on their price. When it happens, a trade is made
and currency is exchanged between the participants.</p><h3 id=liquidity-pools>Liquidity Pools</h3><p>A DEX such as MP does not work with orders. Instead
they use a mechanism based on liquidity pools.</p><p>Every trading pool, for example ZEC, is associated
with two assets. Let&rsquo;s say ZEC and BTC.
This allows a user to swap ZEC for BTC.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The assets are not merged between pairs. BTC in
the ZEC pool is not the same as BTC in the ETH pool.</p></div></div><p>Liquidity providers can contribute funds into any of the pools
by sending to the vault. To indicate their intent, a memo
must be attached to the transaction.</p><p>In the smoke tests, this action is shown as</p><div class="highlight wrap-code"><pre tabindex=0><code>PROVIDER-1 =&gt; VAULT ADD:ZEC.ZEC:PROVIDER-1 2.50000000 ZEC.ZEC</code></pre></div><p>This adds 2.5 ZEC from the user &ldquo;PROVIDER-1&rdquo; into the pool ZEC.</p><div class="highlight wrap-code"><pre tabindex=0><code>PROVIDER-1 =&gt; VAULT ADD:ZEC.ZEC:PROVIDER-1 1,000.00000000 MAYA.CACAO</code></pre></div><p>This add 1000 CACAO to the ZEC pool.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The pool is named as <code>&lt;chain>.&lt;asset></code>. For Zcash that
has a single asset, we use <code>ZEC.ZEC</code> for simplicity.
It could be <code>ZCASH.ZEC</code> too.</p></div></div><h3 id=swaps>Swaps</h3><p>To make a swap, a user sends one type of currency
to the vault and receives the other type of currency
in exchange. The system determines dynamically the exchange
rate based on the amount (= depth) in each of currency
of the swap for the given pool.</p><p>We denote a swap as</p><div class="highlight wrap-code"><pre tabindex=0><code>USER-1 =&gt; VAULT SWAP:MAYA.CACAO:USER-1 1.00000000 ZEC.ZEC</code></pre></div><p>User 1 sent 1 ZEC to the MP vault and wants to receive
CACAO in return.</p><h3 id=memos>Memos</h3><p>As you can see, in addition to the sender/receiver/amount
of the transaction, the memo plays an important role
in specifying the purpose.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>In a real memo, the aliases such as &ldquo;USER-1&rdquo; is replaced
by an address.</p></div></div><h2 id=components>Components</h2><p>Now let&rsquo;s move to the components of MP that makes this
possible in a <em>decentralized</em> and <em>permission-less</em> way.</p><p>Like every decentralized crypto project, there are
many nodes, i.e. computers that run the same set of software.
The nodes maintain a common state that varies between project
but is always eventually persisted in a blockchain.</p><p>For Bitcoin, the state is the amount of BTC associated with
addresses (or output scripts). Users make transactions
that (if correct) modify the state by moving funds from one
address to another.</p><p>In MP, the common state is the amount in the pools
which should track the funds deposited and swapped.
(And also information to track the liquidity providers)</p><p>A transaction would add/remove liquidity, or swap assets.
Consensus is reached when enough (67%) of the validating
nodes agree on the transaction.</p><h3 id=maya-blockchain>Maya blockchain</h3><p>The MP blockchain is the persistent ledger of every state
change in the MP pools. For example, if someone swaps
by doing</p><div class="highlight wrap-code"><pre tabindex=0><code>USER-1 =&gt; VAULT SWAP:MAYA.CACAO:USER-1 1.00000000 ZEC.ZEC</code></pre></div><p>It wil be written in the MP blockchain. Therefore swaps
are not <em>encrypted</em>.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>If a swap between BTC and ZEC uses a shielded address,
the ZEC transaction will be shielded on the Zcash blockchain
and the recipient address and amounts are hidden.</p><p>However, the swap is also recorded on the MP blockchain
and the address and amounts are in clear there.</p></div></div><p>The MP blockchain uses the Tendermint blockchain engine.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Tendermint employs a Byzantine Fault Tolerance algorithm, which allows
the network to reach consensus even if some of the nodes (less than 33%)
act maliciously or are faulty.</p></div></div><h3 id=asguard-vault>Asguard Vault</h3><p>The vault is where the pools keep the funds. Vaults
use threshold signatures for spending and therefore
their public address is a combination of the signing
entities. They rotate frequently. The system will
automatically migrate funds from one vault to the next.</p><p>It is important that users sent funds to the current
vault or their funds will be lost.</p><p>A vault is an address. It is not a process or a node.
There is a single public key that is then encoded
in various chains.</p><p>In other words, the vault address for Bitcoin and
Zcash have the same public key and public key hash.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>Currently, the currencies use the same elliptic curve
(secp256k1) and the same signing algorithm (ECDSA).</p><p>This is a requirement that Zcash fulfills as long
as we use the transparent pool.</p></div></div><h3 id=mayanode>MayaNode</h3><p>Mayanode is the client to the MP blockchain. It is where
the logic for protocol is implemented. Each node runs
the mayanode software. It exposes a REST interface
and is a client to the MP blockchain.</p><p>Mayanode is chain agnostic and operates on the grounds
that all currencies work essentially the same way, i.e.
when you exchange 1 ZEC for BTC, it does not matter
what ZEC and BTC are. The only important factors
are the pool depth (and other pool state).</p><p>Therefore in the Mayanode code, there is no chain
specific code. There is just the list of chain codes
that the MP supports</p><h4 id=adding-zec>Adding ZEC</h4><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>ZEC must be added to the list of supported chains
in <code>support_chains_xxxnet_vxxx.go</code>)</p></div></div><h3 id=bifrost>Bifrost</h3><p>Bifrost is a program that runs along with the mayanode
and interfaces with the crypto currency blockchains
like BTC, ETH, etc.</p><p>It has chain client code that communicates with the
chain nodes.</p><p>For example, in the case of Zcash, we would have</p><pre class="mermaid align-center">
sequenceDiagram
    zcashd -&gt;&gt; zcash_client: observe zcash network
    zcash_client -&gt;&gt; bifrost: wallet, tx parsing
    bifrost -&gt;&gt; mayanode: pool event
</pre><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The <code>zcash_client</code> is a program that bridges
the fullnode zcash client <code>zcashd</code> with bifrost.</p></div></div><p>There are several functionalities that were
not included in <code>zcashd</code> that <code>bitcoind</code> has.
They are going to be emulated by the <code>zcash_client</code>.</p><p>Moreover, the RPC that the bifrost chain client
uses are bitcoin specific and don&rsquo;t work with
shielded addresses.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>There is a single instance of the bifrost
serving all the chains. It is written
in Go.</p></div></div><h2 id=adding-zec-1>Adding ZEC</h2><p>The chainclient code is in <code>pkg/chainclients</code></p><ul><li><code>loadchains</code></li><li><code>client</code></li><li><code>key_sign_wrapper</code></li><li><code>signer</code></li><li><code>tss_signable</code></li></ul><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ChainClient</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SignTx</span>(<span style=color:#a6e22e>tx</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>TxOutItem</span>, <span style=color:#a6e22e>height</span> <span style=color:#66d9ef>int64</span>) ([]<span style=color:#66d9ef>byte</span>, []<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>BroadcastTx</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>TxOutItem</span>, <span style=color:#a6e22e>_</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetHeight</span>() (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetAddress</span>(<span style=color:#a6e22e>poolPubKey</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>PubKey</span>) <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetAccount</span>(<span style=color:#a6e22e>poolPubKey</span> <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>PubKey</span>, <span style=color:#a6e22e>height</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>big</span>.<span style=color:#a6e22e>Int</span>) (<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Account</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetAccountByAddress</span>(<span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>height</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>big</span>.<span style=color:#a6e22e>Int</span>) (<span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Account</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetChain</span>() <span style=color:#a6e22e>common</span>.<span style=color:#a6e22e>Chain</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>OnObservedTxIn</span>(<span style=color:#a6e22e>txIn</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TxInItem</span>, <span style=color:#a6e22e>blockHeight</span> <span style=color:#66d9ef>int64</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>globalTxsQueue</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>TxIn</span>, <span style=color:#a6e22e>globalErrataQueue</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>ErrataBlock</span>, <span style=color:#a6e22e>globalSolvencyQueue</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>Solvency</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetConfig</span>() <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>BifrostChainConfiguration</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetConfirmationCount</span>(<span style=color:#a6e22e>txIn</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>TxIn</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ConfirmationCountReady</span>(<span style=color:#a6e22e>txIn</span> <span style=color:#a6e22e>stypes</span>.<span style=color:#a6e22e>TxIn</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>IsBlockScannerHealthy</span>() <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>and the BlockScanner interface</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// BlockScannerFetcher define the methods a block scanner need to implement
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BlockScannerFetcher</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// FetchMemPool scan the mempool
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>FetchMemPool</span>(<span style=color:#a6e22e>height</span> <span style=color:#66d9ef>int64</span>) (<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TxIn</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// FetchTxs scan block with the given height
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>FetchTxs</span>(<span style=color:#a6e22e>height</span> <span style=color:#66d9ef>int64</span>) (<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TxIn</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GetHeight return current block height
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>GetHeight</span>() (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=bitcoin>Bitcoin</h3><p>The logic is very similar to Bitcoin. The methods can
be separated into 3 groups:</p><ul><li>block and transaction: GetHeight, FetchTxs, GetChain, etc.</li><li>wallet and addresses: GetAccount, GetAccountByAddress,
GetAddress. <code>zebrad</code> will not have an embedded wallet. These
will have to be emulated in <code>zcash-client</code> eventually</li><li>signing</li></ul><p>Signing transactions is more complex than normal
because MP uses threshold signatures (TSS). We&rsquo;ll discuss
them later.</p><h3 id=transparent-zec>Transparent ZEC</h3><p>Transparent ZEC works pretty much the same way as Bitcoin.
We don&rsquo;t foresee major difficulty working with them.
The main issue is that Zcash stayed with legacy addresses
(Base58 Type 1 for Bitcoin), whereas the code uses bech32
p2wkh segwit addresses. This affects address generation
obviously but also signatures.</p><h3 id=shielded-zec>Shielded ZEC</h3><p>Shielded ZEC adds two more complications:</p><ul><li>Sending from zaddr is anonymous. Therefore there is no
way to return the funds if something is wrong with the
transaction. For instance, sending from zec to the vault
without a memo would lead to unrecoverable funds.</li></ul><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>This cannot be prevented at the Zcash protocol level.
Anyone can send funds to any address as long as the
transaction is valid. It just happens that in this case
the funds would end up in the MP vault. However
wallets are expected to follow the MP protocol and include
a return address in the memo or always use transparent
funds.</p></div></div><ul><li>Sending to zaddr is encrypted. The observers
must be able to decrypt the outputs in order to verify
that the outgoing payment is completed successfully.</li></ul><p>This can be achieved by:</p><ol><li>deriving an &ldquo;output viewing key&rdquo;
from the vault public key</li><li>use it when building
the output before signing</li><li>have the validators derive the same OVK</li><li>use that OVK to decrypt the output</li></ol><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The OVK is the BLAKE-2b of the pubkey with personalization
string &ldquo;mayaprotocol-ovk&rdquo;</p></div></div><h3 id=tss>TSS</h3><p>As stated before, signing transactions from the vault
require the participation of multiple signers. They
are clients to the MP blockchain and only sign transactions
that have verified.</p><p>They have a share of the secret key and if 2/3 of them
provide a valid signature, the signatures can be combined
to form a valid transaction. At no point can anyone
reconstruct the vault secret key.</p><p>The TSS algorithm is implemented in the <code>tss-lib</code>, so
we don&rsquo;t need to change that since Zcash also uses
ECDSA on the same EC.</p><p>However, we have to provide the SIGHASH, i.e.
the message to be signed.</p><p>Zcash transactions use a different algorithm
than Bitcoin for calculating the sighash.</p><p>The current MP code (in Bifrost), the transaction
is formed by selecting inputs from UTXOs and outputs
from the swap definition. Then the library BTCD
builds the unsigned transaction and derives the sighash.</p><p>That is to say, the logic that resides in <code>bitcoind</code>
to build transactions from the wallet cannot be used
because <code>bitcoind</code> does not support threshold signatures.
It only supports multisigs.</p><p>As a result, this is performed by the chain client
in <code>signer.go</code></p><p>With Zcash, the algorithm for SIGHASH is completely
different than Bitcoin.</p><p>It is documented in
<a href=https://zips.z.cash/zip-0225 rel=external target=_blank>ZIP-225</a>
and <a href=https://zips.z.cash/zip-0244 rel=external target=_blank>ZIP-244</a></p><p>Therefore, the transaction definition will be sent to
the <code>zcash-client</code> which will return the sighash
and the transaction parts.</p><p>It also responsible for the generation of the zero
knowledge proofs.</p><h3 id=btcd>BTCD</h3><p>BTCSuite is the go library used by btcd,
btcd is an alternative full node bitcoin implementation written in Go.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>There are no golang library for the low level
protocol components of zcash. The code is written
in Rust only.</p></div></div><p>This is another reason for the <code>zcash-client</code> bridge.</p><h2 id=smoke-tests>Smoke Tests</h2><p>The smoke tests use python versions of the chain client
and a simulator for the mayachain.</p><p>We need to add <code>zcash.py</code> to the chain clients,
define the account aliases, add Zcash to the
smoke tests script and to the test transactions.</p><h2 id=docker--deployment>Docker & Deployment</h2><p><code>zcashd</code> has a fairly high deprecation rate. Every
6 months, node operators will have to deploy a new
version. The docker image can be found on a hub.
We need to include it in the docker compose file
and create a zcash service that also has the
<code>zcash-client</code>.</p><p>This is similar to the deployment of other chains
such as LTC, DOGE, etc.</p><p>The difference is the addition of the <code>zcash-client</code>
but that could be made part of the <code>zcash</code> docker image.</p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><img src=https://ywallet.app/icon.png width=64></div><search><form action=/search.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search><script>var contentLangs=["en"]</script><script src=/js/auto-complete.js?1714513868 defer></script><script src=/js/lunr/lunr.min.js?1714513868 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1714513868 defer></script><script src=/js/lunr/lunr.multi.min.js?1714513868 defer></script><script src=/js/lunr/lunr.en.min.js?1714513868 defer></script><script src=/js/search.js?1714513868 defer></script></div><div id=R-homelinks class="default-animation homelinks"><ul><li><a class=padding href=/index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/installation/index.html><a class=padding href=/installation/index.html>Installation</a></li><li data-nav-id=/getting_started/index.html><a class=padding href=/getting_started/index.html>Getting Started</a></li><li data-nav-id=/balance/index.html><a class=padding href=/balance/index.html>Account Info</a><ul id=R-subsections-c0ce48e7e54be67f8892136e0b75b4bf class="morespace collapsible-menu"><li data-nav-id=/balance/sync_status/index.html><a class=padding href=/balance/sync_status/index.html>Sync Status</a></li><li data-nav-id=/balance/addresses/index.html><a class=padding href=/balance/addresses/index.html>Addresses</a></li><li data-nav-id=/balance/balance/index.html><a class=padding href=/balance/balance/index.html>Balance</a></li><li data-nav-id=/balance/payment_uri/index.html><a class=padding href=/balance/payment_uri/index.html>Payment URI</a></li></ul></li><li data-nav-id=/security/index.html><a class=padding href=/security/index.html>Security</a><ul id=R-subsections-4e896db703975006e00bbc21e8553d62 class="morespace collapsible-menu"><li data-nav-id=/security/pin/index.html><a class=padding href=/security/pin/index.html>PIN/Fingerprint</a></li><li data-nav-id=/security/db/index.html><a class=padding href=/security/db/index.html>Database Encryption</a></li></ul></li><li data-nav-id=/transacting/index.html><a class=padding href=/transacting/index.html>Transacting</a><ul id=R-subsections-ca3d3a22791220416c9d3f3e930f25e5 class="morespace collapsible-menu"><li data-nav-id=/transacting/receive/index.html><a class=padding href=/transacting/receive/index.html>Receive</a></li><li data-nav-id=/transacting/send/index.html><a class=padding href=/transacting/send/index.html>Send</a></li><li data-nav-id=/transacting/report/index.html><a class=padding href=/transacting/report/index.html>Transaction Report</a></li></ul></li><li data-nav-id=/contacts/index.html><a class=padding href=/contacts/index.html>Contacts</a></li><li data-nav-id=/history/index.html><a class=padding href=/history/index.html>History</a><ul id=R-subsections-28afe07b1f43a9e9c0c12d4859c39ee9 class="morespace collapsible-menu"><li data-nav-id=/history/details/index.html><a class=padding href=/history/details/index.html>Transaction Details</a></li></ul></li><li data-nav-id=/messages/index.html><a class=padding href=/messages/index.html>Messages</a><ul id=R-subsections-5170110ba0d4fc57fb4d4740e9c11df2 class="morespace collapsible-menu"><li data-nav-id=/messages/details/index.html><a class=padding href=/messages/details/index.html>Message Details</a></li></ul></li><li data-nav-id=/pools/index.html><a class=padding href=/pools/index.html>Pools</a></li><li data-nav-id=/sync/index.html><a class=padding href=/sync/index.html>Synchronization</a><ul id=R-subsections-372fd7eb42f732e8285ae22a455d3003 class="morespace collapsible-menu"><li data-nav-id=/sync/rescan/index.html><a class=padding href=/sync/rescan/index.html>Rescan</a></li><li data-nav-id=/sync/rewind/index.html><a class=padding href=/sync/rewind/index.html>Rewind</a></li></ul></li><li data-nav-id=/accounts/index.html><a class=padding href=/accounts/index.html>Account Manager</a><ul id=R-subsections-2a774af53cc539e1e5beb0ad00d1b712 class="morespace collapsible-menu"><li data-nav-id=/accounts/new/index.html><a class=padding href=/accounts/new/index.html>New Account</a></li><li data-nav-id=/accounts/notes/index.html><a class=padding href=/accounts/notes/index.html>Notes</a></li></ul></li><li data-nav-id=/backup/index.html><a class=padding href=/backup/index.html>Backup</a><ul id=R-subsections-47c86b4d9ae606d8a8f3f6ab457f570b class="morespace collapsible-menu"><li data-nav-id=/backup/seed/index.html><a class=padding href=/backup/seed/index.html>Seed & Keys</a></li><li data-nav-id=/backup/app/index.html><a class=padding href=/backup/app/index.html>App Backup</a></li></ul></li><li data-nav-id=/coldwallet/index.html><a class=padding href=/coldwallet/index.html>Cold Wallet</a></li><li data-nav-id=/market/index.html><a class=padding href=/market/index.html>Market Insights</a><ul id=R-subsections-44c0c5a43bed7f757b53d5ca39c1fc5b class="morespace collapsible-menu"><li data-nav-id=/market/budget/index.html><a class=padding href=/market/budget/index.html>Budget</a></li><li data-nav-id=/market/price/index.html><a class=padding href=/market/price/index.html>Price Chart</a></li></ul></li><li data-nav-id=/multipay/index.html><a class=padding href=/multipay/index.html>MultiPay</a></li><li data-nav-id=/tools/index.html><a class=padding href=/tools/index.html>Recovery Tools</a><ul id=R-subsections-119695d21223206d3a21952913ee96ab class="morespace collapsible-menu"><li data-nav-id=/tools/key_derivation/index.html><a class=padding href=/tools/key_derivation/index.html>Key Derivation</a></li><li data-nav-id=/tools/sweep/index.html><a class=padding href=/tools/sweep/index.html>Sweep Funds</a></li></ul></li><li data-nav-id=/settings/index.html><a class=padding href=/settings/index.html>Settings</a><ul id=R-subsections-41fb242962607634ac0ea22f61041d4b class="morespace collapsible-menu"><li data-nav-id=/settings/general/index.html><a class=padding href=/settings/general/index.html>General</a></li><li data-nav-id=/settings/privacy/index.html><a class=padding href=/settings/privacy/index.html>Privacy</a></li><li data-nav-id=/settings/view/index.html><a class=padding href=/settings/view/index.html>View</a></li><li data-nav-id=/settings/coin/index.html><a class=padding href=/settings/coin/index.html>Coin</a></li><li data-nav-id=/settings/theme/index.html><a class=padding href=/settings/theme/index.html>Theme</a></li></ul></li><li data-nav-id=/audit/index.html><a class=padding href=/audit/index.html>Security & Audit</a></li><li data-nav-id=/maya/index.html class="active parent"><a class=padding href=/maya/index.html>Maya Protocol / Zcash</a><ul id=R-subsections-5930b0615e07c1663288621db7cfa623 class="morespace collapsible-menu"><li data-nav-id=/maya/deposit/index.html><a class=padding href=/maya/deposit/index.html>Deposit</a></li><li data-nav-id=/maya/withdraw/index.html><a class=padding href=/maya/withdraw/index.html>Withdraw</a></li><li data-nav-id=/maya/swap_from/index.html><a class=padding href=/maya/swap_from/index.html>Swap From ZEC</a></li><li data-nav-id=/maya/swap_to/index.html><a class=padding href=/maya/swap_to/index.html>Swap To ZEC</a></li></ul></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Language</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-auto value=auto selected>Auto</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></div></aside><script src=/js/clipboard.min.js?1714513868 defer></script><script src=/js/perfect-scrollbar.min.js?1714513868 defer></script><script src=/js/d3/d3-color.min.js?1714513868 defer></script><script src=/js/d3/d3-dispatch.min.js?1714513868 defer></script><script src=/js/d3/d3-drag.min.js?1714513868 defer></script><script src=/js/d3/d3-ease.min.js?1714513868 defer></script><script src=/js/d3/d3-interpolate.min.js?1714513868 defer></script><script src=/js/d3/d3-selection.min.js?1714513868 defer></script><script src=/js/d3/d3-timer.min.js?1714513868 defer></script><script src=/js/d3/d3-transition.min.js?1714513868 defer></script><script src=/js/d3/d3-zoom.min.js?1714513868 defer></script><script src=/js/js-yaml.min.js?1714513868 defer></script><script src=/js/mermaid.min.js?1714513868 defer></script><script>window.themeUseMermaid=JSON.parse("{}")</script><script src=/js/theme.js?1714513868 defer></script></body></html>